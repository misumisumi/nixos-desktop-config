name: build check
on:
  pull_request:

permissions:
  actions: read
  attestations: read
  checks: read
  contents: read
  deployments: read
  discussions: read
  id-token: write
  issues: read
  packages: read
  pages: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  pre-workflow:
    uses: ./.github/workflows/agent-of-me.yml
    with:
      pr-number: ${{ github.event.pull_request.number }}
      triggered-name: "build check"
    secrets:
      AGENT_OF_ME_APP_ID: ${{ secrets.AGENT_OF_ME_APP_ID }}
      AGENT_OF_ME_PRIVATE_KEY: ${{ secrets.AGENT_OF_ME_PRIVATE_KEY }}

  build-check-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        hostname:
          [
            "mother",
            "stacia",
            "zephyrus",
            "liveimg-minimal-iso",
            "liveimg-gnome-iso",
          ]
    steps:
      - uses: dorny/paths-filter@v3
        id: change
        with:
          filters: |
            nix:
              - "**.nix"
              - "flake.lock"
              - chezmoi/.chezmoidata/apps/**
              - chezmoi/.chezmoitemplates/starship/**

      - uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: "rampage" # Options: holster, carve, cleave (default), rampage
          root-safe-haven: "8192"

      - uses: actions/checkout@v6
        if: steps.change.outputs.nix == 'true'

      - uses: cachix/install-nix-action@v31
        if: steps.change.outputs.nix == 'true'
        with:
          extra_nix_config: |
            accept-flake-config = true
            connect-timeout = 15
            cores = 2
            http-connections = 25
            max-jobs = 2
            stalled-download-timeout = 15

      - name: Build check
        if: steps.change.outputs.nix == 'true'
        timeout-minutes: 70
        run: nix build --no-link ".#nixosConfigurations.${{ matrix.hostname }}.config.system.build.toplevel"

  build-check-summary:
    runs-on: ubuntu-latest
    needs: [pre-workflow, build-check-matrix]
    steps:
      - name: build-check-success
        if: needs.build-check-matrix.result == 'success'
        run: |
          exit 0
      - name: build-check-failed
        if: needs.build-check-matrix.result != 'success'
        run: |
          exit 1

  post-workflow:
    uses: ./.github/workflows/agent-of-me.yml
    needs: [pre-workflow, build-check-summary]
    with:
      pr-number: ${{ github.event.pull_request.number }}
      triggered-name: "build check"
    secrets:
      AGENT_OF_ME_APP_ID: ${{ secrets.AGENT_OF_ME_APP_ID }}
      AGENT_OF_ME_PRIVATE_KEY: ${{ secrets.AGENT_OF_ME_PRIVATE_KEY }}
