{{- $os := .chezmoi.os -}}
{{- $osConfig := or (get . $os) dict -}}

{{- $userName := .chezmoi.username -}}
{{- $userConfig := or (get (or (get $osConfig "users") dict) $userName) dict -}}
{{- $userPkgConfigs := or (get $userConfig "packages") dict -}}
{{- $mcpServers := or (get $userPkgConfigs "mcp-servers") dict -}}

function Write-Log {
    param([string]$Message)
    Write-Host "$(Split-Path -Leaf $MyInvocation.MyCommand.Path): $Message"
}

function Check-Command {
    param([string]$cmd)
    if (-not (Get-Command $cmd -ErrorAction SilentlyContinue)) {
        Write-Log "$cmd is not installed. Please install $cmd first."
        exit 1
    }
}

Check-Command "npm"
Check-Command "python"
Check-Command "go"

function BinWrapper {
    param (
        [string]$OutputPath,
        [string]$Command
    )

    $scriptContent = @"
@ECHO off
SET dp0=%~dp0
$Command
"@

    Set-Content -Path $OutputPath -Value $scriptContent -Encoding ASCII
}

function Install-NodePackage {
    param($name, $pname)
    $pkgDir = Join-Path $PKGDIR $name
    Write-Log "Installing package: $name ..."
    New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
    Push-Location $pkgDir
    npm install $pname
    $binPath = Join-Path $BINDIR $name
    $target = Join-Path $pkgDir "node_modules\.bin\$name"
    Copy-Item $target $binPath -Force
    Pop-Location
    Write-Log "Package '$name' installed successfully."
}

function Install-PipPackage {
    param($name, $pname)
    $pkgDir = Join-Path $PKGDIR $name
    Write-Log "Installing package: $name ..."
    New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
    Push-Location $pkgDir
    python -m venv venv
    & "$pkgDir\venv\Scripts\python.exe" -m pip install $pname
    $binPath = Join-Path $BINDIR $name
    $target = "$pkgDir\venv\Scripts\$name.exe"
    Copy-Item $target $binPath -Force
    Pop-Location
    Write-Log "Package '$name' installed successfully."
}

function Install-PythonPackage {
    param($name, $giturl, $mname)
    $pkgDir = Join-Path $PKGDIR $name
    Write-Log "Installing package: $name ..."
    New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
    Push-Location $pkgDir
    git clone $giturl .
    python -m venv venv
    & "$pkgDir\venv\Scripts\python.exe" -m pip install -e .
    $binPath = Join-Path $BINDIR $name
    if ($mname -match "\.py") {
        $script = Get-ChildItem -Path $pkgDir -Filter $mname -Recurse | Select-Object -First 1
        BinWrapper -OutputPath $binPath -Command "\"$pkgDir\venv\Scripts\python.exe`\" $($script.FullName) `$args"
    } else {
        BinWrapper -OutputPath $binPath -Command "\"$pkgDir\venv\Scripts\python.exe`\" -m $mname `$args"
    }
    Pop-Location
    Write-Log "Package '$name' installed successfully."
}

$MCP_SERVERS_ROOT = $env:MCP_SERVERS_ROOT
if (-not $MCP_SERVERS_ROOT) { $MCP_SERVERS_ROOT = Join-Path $env:XDG_DATA_HOME "mcp-servers" }
$PKGDIR = Join-Path $MCP_SERVERS_ROOT "packages"
$BINDIR = Join-Path $MCP_SERVERS_ROOT "bin"
New-Item -ItemType Directory -Force -Path $BINDIR | Out-Null

{{ range $type, $pkgs := $mcpServers -}}
{{ if (eq $type "node") -}}
{{ range $name, $pname := $pkgs -}}
Install-NodePackage "{{ $name }}" "{{ $pname }}"
{{ end -}}
{{ else if (eq $type "pip") -}}
{{ range $name, $pname := $pkgs -}}
Install-PipPackage "{{ $name }}" "{{ $pname }}"
{{ end -}}
{{ else if (eq $type "python") -}}
{{ range $name, $value := $pkgs -}}
Install-PythonPackage "{{ $name }}" "{{ $value.giturl }}" "{{ $value.module }}"
{{ end -}}
{{ else if (eq $type "general") -}}
{{ range $name, $value := $pkgs -}}
$name = "{{ $name }}"
$pkgDir = Join-Path $PKGDIR $name
Write-Log "Installing package: $name ..."
New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
Push-Location $pkgDir
{{ $value }}
Pop-Location
Write-Log "Package '$name' installed successfully."
{{ end -}}
{{ end -}}
{{ end -}}

Write-Log "Finish"
